# Extraer el compilador usado desde CMakeCache.txt
COMPILER_ID=$(grep "CMAKE_CXX_COMPILER_ID:" CMakeCache.txt | cut -d'=' -f2)

if [[ "$COMPILER_ID" =~ Clang ]]; then
    echo "Usando llvm-cov (Clang)"
    export LLVM_PROFILE_FILE="coverage_%p.profraw"
    ctest --verbose
    llvm-profdata merge -sparse coverage_*.profraw -o coverage.profdata
    llvm-cov export ./bin/tests -instr-profile=coverage.profdata -format=lcov > coverage.info
elif [[ "$COMPILER_ID" =~ GNU ]]; then
    echo "Usando gcov/lcov (GCC)"
    lcov --directory . --zerocounters
    ctest --verbose
    lcov --directory . --capture --output-file coverage.info
else
    echo "Compilador no soportado para cobertura"
    exit 1
fi

genhtml coverage.info --output-directory ../coverage
echo "Informe de cobertura generado en la carpeta 'coverage'."